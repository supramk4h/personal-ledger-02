<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%232563eb'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z' /%3E%3C/svg%3E" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Cashbook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: { "50": "#eff6ff", "100": "#dbeafe", "200": "#bfdbfe", "300": "#93c5fd", "400": "#60a5fa", "500": "#3b82f6", "600": "#2563eb", "700": "#1d4ed8", "800": "#1e40af", "900": "#1e3a8a", "950": "#172554" }
            }
          }
        }
      }
    </script>
<style type="text/css">
  .page { display: none; }
  .page.active { display: block; }
  #mobile-sidebar-container.open { transform: translateX(0%); }
  #mobile-sidebar-container { transition: transform 0.3s ease-in-out; }
  .modal-container {
    transition: opacity 0.3s ease;
  }
  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .chart-container {
    position: relative;
    height: 300px;
    width: 100%;
  }
  @media print {
    body * { visibility: hidden; }
    #printable-area, #printable-area * { visibility: visible; }
    #printable-area { position: absolute; left: 0; top: 0; width: 100%; }
    .dark-mode-print-fix .dark\:bg-gray-800,
    .dark-mode-print-fix .dark\:bg-gray-900 {
      background-color: white !important;
    }
    .dark-mode-print-fix .dark\:text-white,
    .dark-mode-print-fix .dark\:text-gray-300,
    .dark-mode-print-fix .dark\:text-gray-400 {
      color: black !important;
    }
    .dark-mode-print-fix .dark\:border-gray-700 {
      border-color: #ccc !important;
    }
  }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div id="app"></div>
    <div id="loading" class="fixed inset-0 bg-white dark:bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto"></div>
            <p class="mt-4 text-gray-600 dark:text-gray-400">Loading Cashbook...</p>
        </div>
    </div>

<script type="module">
// --- SUPABASE CONFIGURATION ---
const SUPABASE_URL = 'https://iuruhsphunthqzponmoh.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1cnVoc3BodW50aHF6cG9ubW9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3Mjc1NzcsImV4cCI6MjA3NjMwMzU3N30.jbtECT4aNWAt_aQLa64kum_v03lIkre4Ivgb1N0jHwA';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- CORE STATE & CONFIG ---
const ICONS = {
    ChartPie: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" /></svg>`,
    CreditCard: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15A2.25 2.25 0 002.25 6.75v10.5A2.25 2.25 0 004.5 19.5z" /></svg>`,
    DocumentText: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>`,
    PresentationChartLine: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h12A2.25 2.25 0 0020.25 14.25V3m-16.5 0h16.5m-16.5 0H3.75m16.5 0h.008v.008h-.008V3zM3.75 7.5h16.5m-16.5 0h.008v.008H3.75V7.5zm16.5 0h.008v.008h-.008V7.5zm-16.5 3.75h16.5m-16.5 0h.008v.008H3.75v-.008zm16.5 0h.008v.008h-.008v-.008z" /></svg>`,
    Cog6Tooth: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-1.226.55-.22 1.156-.22 1.706 0 .55.22 1.02.684 1.11 1.226l.082.498a1.5 1.5 0 001.256 1.053l.547.098a1.5 1.5 0 011.332 1.002l.24.577a1.5 1.5 0 01-.398 1.623l-.433.39a1.5 1.5 0 00-.54 1.257l.012.59a1.5 1.5 0 01-1.028 1.353l-.537.227a1.5 1.5 0 00-1.053 1.256l-.082.498c-.09.542-.56 1.007-1.11 1.226-.55.22-1.156-.22-1.706 0-.55-.22-1.02-.684-1.11-1.226l-.082-.498a1.5 1.5 0 00-1.256-1.053l-.547-.098a1.5 1.5 0 01-1.332-1.002l-.24-.577a1.5 1.5 0 01.398-1.623l.433-.39a1.5 1.5 0 00.54-1.257l-.012-.59a1.5 1.5 0 011.028-1.353l.537-.227a1.5 1.5 0 001.053-1.256l.082-.498z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
    Banknotes: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>`,
    Bars3: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>`,
    Sun: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>`,
    Moon: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.921-.994 6.752-2.698z" /></svg>`,
    ArrowTrendingUp: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-3.75-.625m3.75.625v3.75" /></svg>`,
    ArrowTrendingDown: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6L9 12.75l4.286-4.286a11.948 11.948 0 014.306 6.43l.776 2.898m0 0l3.182-5.511m-3.182 5.511l-5.511-3.182" /></svg>`,
    Wallet: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 3a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m15 0a2.25 2.25 0 01-2.25 2.25H9a2.25 2.25 0 01-2.25-2.25m13.5 0a2.25 2.25 0 00-2.25-2.25H9a2.25 2.25 0 00-2.25 2.25" /></svg>`,
    PlusCircle: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
    DocumentPlus: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m6.75 12l-3-3m0 0l-3 3m3-3v6m-1.5-15H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>`,
    UserPlus: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.5 21h-5A12.318 12.318 0 014 19.235z" /></svg>`,
    PencilSquare: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>`,
    Trash: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.033-2.124H8.033c-1.124 0-2.033.944-2.033 2.124v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>`,
    Plus: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>`,
    XMark: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`,
    Printer: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0110.56 0m-10.56 0L6 18.25m10.56-4.421l.54 4.421m-11.64-4.421L3 18.25m11.64 0l.54 4.421m0 0L21 18.25m-18 0l-1.17-1.17A41.296 41.296 0 013 11.25c0-2.02.586-3.94 1.636-5.618L4.5 4.5m17 2.25l-1.17 1.17a41.296 41.296 0 00-1.636 5.618c0 2.02.586 3.94 1.636 5.618L19.5 18.25m-15-13.5l1.17-1.17A41.312 41.312 0 0112 3c1.86 0 3.653.27 5.336.75l1.17 1.17m-10.5 10.5c.34.036.68.069 1.02.102m7.44 0c.34-.033.68-.066 1.02-.102m-8.46 0L12 12.75m0 0l.621 5.013M12 12.75l-.621 5.013" /></svg>`,
    ExclamationTriangle: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
    CheckCircle: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
    CloudArrowUp: (c) => `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="${c}"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>`,
};

const NAVIGATION_ITEMS = [
  { path: '#/', name: 'Dashboard', icon: ICONS.ChartPie },
  { path: '#/accounts', name: 'Accounts', icon: ICONS.CreditCard },
  { path: '#/vouchers', name: 'Vouchers', icon: ICONS.DocumentText },
  { path: '#/reports', name: 'Reports', icon: ICONS.PresentationChartLine },
  { path: '#/settings', name: 'Settings', icon: ICONS.Cog6Tooth },
];

const AccountType = {
    Cash: 'Cash', Bank: 'Bank', Expense: 'Expense', Income: 'Income',
    Asset: 'Asset', Liability: 'Liability', Equity: 'Equity', Other: 'Other',
};

const VoucherType = {
    Journal: 'Journal', 
    Payment: 'Payment', 
    Receipt: 'Receipt'
};

// --- VOUCHER NUMBERING SYSTEM ---
let voucherSequences = {
    Journal: 0,
    Payment: 0,
    Receipt: 0
};

// Initialize voucher sequences from existing data
function initializeVoucherSequences() {
    // Reset sequences
    voucherSequences = { Journal: 0, Payment: 0, Receipt: 0 };
    
    // Find the highest numbers for each voucher type
    state.vouchers.forEach(voucher => {
        if (voucher.voucher_number) {
            const match = voucher.voucher_number.match(/(JV|PV|RV)-(\d+)/);
            if (match) {
                const type = match[1] === 'JV' ? 'Journal' : 
                            match[1] === 'PV' ? 'Payment' : 'Receipt';
                const number = parseInt(match[2]);
                if (number > voucherSequences[type]) {
                    voucherSequences[type] = number;
                }
            }
        }
    });
}

// Generate next voucher number for a type
function generateVoucherNumber(type) {
    let prefix;
    switch(type) {
        case 'Journal': prefix = 'JV'; break;
        case 'Payment': prefix = 'PV'; break;
        case 'Receipt': prefix = 'RV'; break;
        default: prefix = 'JV';
    }
    
    voucherSequences[type]++;
    return `${prefix}-${voucherSequences[type].toString().padStart(4, '0')}`;
}

// --- PASSWORD PROTECTION ---
const PASSWORD = '123';

function askPassword(actionDescription) {
    return new Promise((resolve) => {
        const password = prompt(`Please enter password to ${actionDescription}:\n(Password is 123)`);
        if (password === PASSWORD) {
            resolve(true);
        } else {
            alert('Incorrect password. Action cancelled.');
            resolve(false);
        }
    });
}

// --- STATE MANAGEMENT ---
let state = {
    accounts: [],
    vouchers: [],
    settings: { currency: '$' },
    theme: 'light',
    ui: { isSidebarOpen: false }
};

// --- SUPABASE DATA OPERATIONS ---
const loadData = async () => {
    try {
        // Load accounts
        const { data: accounts, error: accountsError } = await supabase
            .from('accounts')
            .select('*')
            .order('name');
        
        if (accountsError) throw accountsError;

        // Load vouchers with entries
        const { data: vouchers, error: vouchersError } = await supabase
            .from('vouchers')
            .select(`
                *,
                voucher_entries (*)
            `)
            .order('date', { ascending: false });
        
        if (vouchersError) throw vouchersError;

        // Load settings
        const { data: settings, error: settingsError } = await supabase
            .from('settings')
            .select('*')
            .single();
        
        if (settingsError && settingsError.code !== 'PGRST116') throw settingsError;

        const data = {
            accounts: accounts || [],
            vouchers: vouchers || [],
            settings: settings || { currency: '$' }
        };

        // Initialize voucher sequences after loading data
        initializeVoucherSequences();

        return data;
    } catch (error) {
        console.error("Error loading data from Supabase:", error);
        showError('Failed to load data from database. Please check your connection.');
        return {
            accounts: [],
            vouchers: [],
            settings: { currency: '$' }
        };
    }
};

const saveAccount = async (accountData) => {
    try {
        if (accountData.id) {
            // Update existing account
            const { data, error } = await supabase
                .from('accounts')
                .update({
                    name: accountData.name,
                    type: accountData.type,
                    opening_balance: accountData.openingBalance,
                    updated_at: new Date().toISOString()
                })
                .eq('id', accountData.id)
                .select()
                .single();
            
            if (error) throw error;
            return data;
        } else {
            // Create new account
            const { data, error } = await supabase
                .from('accounts')
                .insert({
                    name: accountData.name,
                    type: accountData.type,
                    opening_balance: accountData.openingBalance
                })
                .select()
                .single();
            
            if (error) throw error;
            return data;
        }
    } catch (error) {
        console.error("Error saving account:", error);
        throw error;
    }
};

const deleteAccount = async (id) => {
    try {
        const { error } = await supabase
            .from('accounts')
            .delete()
            .eq('id', id);
        
        if (error) throw error;
    } catch (error) {
        console.error("Error deleting account:", error);
        throw error;
    }
};

const saveVoucher = async (voucherData) => {
    try {
        if (voucherData.id) {
            // Update existing voucher - keep existing voucher_number
            const { data: voucher, error: voucherError } = await supabase
                .from('vouchers')
                .update({
                    date: voucherData.date,
                    type: voucherData.type,
                    narration: voucherData.narration,
                    updated_at: new Date().toISOString()
                })
                .eq('id', voucherData.id)
                .select()
                .single();
            
            if (voucherError) throw voucherError;

            // Delete existing entries
            await supabase
                .from('voucher_entries')
                .delete()
                .eq('voucher_id', voucherData.id);

            // Insert new entries
            const entries = voucherData.entries.map(entry => ({
                voucher_id: voucherData.id,
                account_id: entry.accountId,
                narration: entry.narration,
                debit: entry.debit,
                credit: entry.credit
            }));

            const { error: entriesError } = await supabase
                .from('voucher_entries')
                .insert(entries);
            
            if (entriesError) throw entriesError;

            return voucher;
        } else {
            // Create new voucher - generate voucher number
            const voucherNumber = generateVoucherNumber(voucherData.type);
            
            const { data: voucher, error: voucherError } = await supabase
                .from('vouchers')
                .insert({
                    date: voucherData.date,
                    type: voucherData.type,
                    narration: voucherData.narration,
                    voucher_number: voucherNumber
                })
                .select()
                .single();
            
            if (voucherError) throw voucherError;

            // Insert entries
            const entries = voucherData.entries.map(entry => ({
                voucher_id: voucher.id,
                account_id: entry.accountId,
                narration: entry.narration,
                debit: entry.debit,
                credit: entry.credit
            }));

            const { error: entriesError } = await supabase
                .from('voucher_entries')
                .insert(entries);
            
            if (entriesError) throw entriesError;

            return voucher;
        }
    } catch (error) {
        console.error("Error saving voucher:", error);
        throw error;
    }
};

const deleteVoucher = async (id) => {
    try {
        const { error } = await supabase
            .from('vouchers')
            .delete()
            .eq('id', id);
        
        if (error) throw error;
    } catch (error) {
        console.error("Error deleting voucher:", error);
        throw error;
    }
};

const updateSettings = async (newSettings) => {
    try {
        const { data: existingSettings } = await supabase
            .from('settings')
            .select('*')
            .single();

        if (existingSettings) {
            // Update existing settings
            const { data, error } = await supabase
                .from('settings')
                .update({
                    currency: newSettings.currency,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingSettings.id)
                .select()
                .single();
            
            if (error) throw error;
            return data;
        } else {
            // Create new settings
            const { data, error } = await supabase
                .from('settings')
                .insert({
                    currency: newSettings.currency
                })
                .select()
                .single();
            
            if (error) throw error;
            return data;
        }
    } catch (error) {
        console.error("Error updating settings:", error);
        throw error;
    }
};

// --- CALCULATIONS ---
const calculateAccountBalance = (accountId) => {
    const account = state.accounts.find(a => a.id === accountId);
    if (!account) return 0;
    let balance = parseFloat(account.opening_balance) || 0;
    state.vouchers.forEach(voucher => {
        voucher.voucher_entries.forEach(entry => {
            if (entry.account_id === accountId) {
                balance += parseFloat(entry.debit) - parseFloat(entry.credit);
            }
        });
    });
    return balance;
};

const calculateAccountBalanceAsOf = (accountId, asOfDate) => {
    const account = state.accounts.find(a => a.id === accountId);
    if (!account) return 0;
    let balance = parseFloat(account.opening_balance) || 0;
    state.vouchers
        .filter(v => new Date(v.date) < asOfDate)
        .forEach(voucher => {
            voucher.voucher_entries.forEach(entry => {
                if (entry.account_id === accountId) {
                    balance += parseFloat(entry.debit) - parseFloat(entry.credit);
                }
            });
        });
    return balance;
};

// --- STATE MUTATIONS (CRUD) ---
async function addAccount(accountData) {
    try {
        const newAccount = await saveAccount(accountData);
        state.accounts.push(newAccount);
        renderApp();
        showSuccess('Account created successfully!');
        return true;
    } catch (error) {
        showError('Error saving account: ' + error.message);
        return false;
    }
}

async function updateAccount(id, accountData) {
    try {
        const updatedAccount = await saveAccount({ ...accountData, id });
        state.accounts = state.accounts.map(acc => acc.id === id ? updatedAccount : acc);
        renderApp();
        showSuccess('Account updated successfully!');
        return true;
    } catch (error) {
        showError('Error updating account: ' + error.message);
        return false;
    }
}

async function deleteAccountById(id) {
    const isUsed = state.vouchers.some(v => v.voucher_entries.some(e => e.account_id === id));
    if (isUsed) {
        showError('This account cannot be deleted because it is used in one or more vouchers.');
        return false;
    }
    
    try {
        await deleteAccount(id);
        state.accounts = state.accounts.filter(acc => acc.id !== id);
        renderApp();
        showSuccess('Account deleted successfully!');
        return true;
    } catch (error) {
        showError('Error deleting account: ' + error.message);
        return false;
    }
}

async function addVoucher(voucherData) {
    try {
        const newVoucher = await saveVoucher(voucherData);
        // Reload data to get the complete voucher with entries
        const data = await loadData();
        state.vouchers = data.vouchers;
        window.location.hash = '/vouchers';
        showSuccess('Voucher created successfully!');
        return true;
    } catch (error) {
        showError('Error saving voucher: ' + error.message);
        return false;
    }
}

async function updateVoucher(id, voucherData) {
    try {
        await saveVoucher({ ...voucherData, id });
        // Reload data to get updated voucher with entries
        const data = await loadData();
        state.vouchers = data.vouchers;
        window.location.hash = '/vouchers';
        showSuccess('Voucher updated successfully!');
        return true;
    } catch (error) {
        showError('Error updating voucher: ' + error.message);
        return false;
    }
}

async function deleteVoucherById(id) {
    try {
        await deleteVoucher(id);
        state.vouchers = state.vouchers.filter(v => v.id !== id);
        renderApp();
        showSuccess('Voucher deleted successfully!');
        return true;
    } catch (error) {
        showError('Error deleting voucher: ' + error.message);
        return false;
    }
}

async function updateSettingsInDB(newSettings) {
    try {
        const updatedSettings = await updateSettings(newSettings);
        state.settings = updatedSettings;
        showSuccess('Settings saved successfully!');
        renderApp();
        return true;
    } catch (error) {
        showError('Error saving settings: ' + error.message);
        return false;
    }
}

// --- UI THEME ---
function applyTheme(theme) {
    const effectiveTheme = theme || state.theme || 'light';
    if (effectiveTheme === 'dark') {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
    state.theme = effectiveTheme;
    localStorage.setItem('theme', effectiveTheme);
}

function toggleTheme() {
    const newTheme = state.theme === 'light' ? 'dark' : 'light';
    applyTheme(newTheme);
    renderApp();
}

// --- NOTIFICATION SYSTEM ---
function showError(message) {
    showNotification(message, 'error');
}

function showSuccess(message) {
    showNotification(message, 'success');
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    const bgColor = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500';
    const icon = type === 'error' ? ICONS.ExclamationTriangle('w-5 h-5') : 
                 type === 'success' ? ICONS.CheckCircle('w-5 h-5') : 
                 ICONS.ExclamationTriangle('w-5 h-5');
    
    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50 flex items-center space-x-2 fade-in`;
    notification.innerHTML = `
        ${icon}
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// --- RENDERING: COMPONENTS ---
const formatCurrency = (amount) => `${state.settings.currency} ${Number(amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

const Sidebar = () => `
    <div class="flex flex-col w-64 h-full bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-center h-16 border-b dark:border-gray-700">
        ${ICONS.Banknotes('w-8 h-8 text-primary-600')}
        <span class="ml-2 text-xl font-bold text-gray-800 dark:text-white">Cashbook</span>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        ${NAVIGATION_ITEMS.map(item => {
            const isActive = (window.location.hash || '#/') === item.path;
            return `
              <a href="${item.path}" class="flex items-center px-4 py-2 text-sm font-medium rounded-md transition-colors duration-150 ${isActive ? 'bg-primary-100 text-primary-700 dark:bg-primary-900/50 dark:text-primary-300' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}">
                ${item.icon('w-5 h-5 mr-3')}
                ${item.name}
              </a>`;
        }).join('')}
      </nav>
    </div>`;

const Header = () => `
    <header class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 md:hidden">
      <div class="flex items-center">
        <button data-action="toggle-sidebar" class="p-2 mr-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
            ${ICONS.Bars3('w-6 h-6')}
        </button>
        <div class="flex items-center">
            ${ICONS.Banknotes('w-7 h-7 text-primary-600')}
            <h1 class="ml-2 text-xl font-bold">Cashbook</h1>
        </div>
      </div>
      <button data-action="toggle-theme" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
        ${state.theme === 'light' ? ICONS.Moon('w-6 h-6') : ICONS.Sun('w-6 h-6')}
      </button>
    </header>`;
    
const Dashboard = () => {
    const totalInflow = state.vouchers.reduce((sum, v) => sum + v.voucher_entries.reduce((s, e) => s + parseFloat(e.credit), 0), 0);
    const totalOutflow = state.vouchers.reduce((sum, v) => sum + v.voucher_entries.reduce((s, e) => s + parseFloat(e.debit), 0), 0);
    const netBalance = totalInflow - totalOutflow;
    const recentTransactions = [...state.vouchers].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()).slice(0, 5);

    // Monthly Chart Data
    const monthlyDataMap = new Map();
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 5);
    sixMonthsAgo.setDate(1);
    for (let i = 0; i < 6; i++) {
        const date = new Date(sixMonthsAgo.getFullYear(), sixMonthsAgo.getMonth() + i, 1);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const name = date.toLocaleString('default', { month: 'short' });
        monthlyDataMap.set(key, { name, inflow: 0, outflow: 0 });
    }
    state.vouchers.forEach(voucher => {
        const date = new Date(voucher.date);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (monthlyDataMap.has(key)) {
            const data = monthlyDataMap.get(key);
            data.inflow += voucher.voucher_entries.reduce((s, e) => s + parseFloat(e.credit), 0);
            data.outflow += voucher.voucher_entries.reduce((s, e) => s + parseFloat(e.debit), 0);
        }
    });
    const monthlyChartData = Array.from(monthlyDataMap.values());

    // Category Chart Data
    const categoryMap = new Map();
    state.vouchers.forEach(voucher => {
        voucher.voucher_entries.forEach(entry => {
            if(parseFloat(entry.debit) > 0) {
                const account = state.accounts.find(a => a.id === entry.account_id);
                const accountName = account ? account.name : 'Unknown';
                categoryMap.set(accountName, (categoryMap.get(accountName) || 0) + parseFloat(entry.debit));
            }
        });
    });
    let mainCategories = Array.from(categoryMap.entries()).sort((a,b) => b[1] - a[1]);
    let otherValue = 0;
    if (mainCategories.length > 5) {
        const others = mainCategories.splice(5);
        otherValue = others.reduce((sum, [, value]) => sum + value, 0);
    }
    if (otherValue > 0) mainCategories.push(['Other', otherValue]);

    // Income vs Expense Data
    const incomeExpenseData = {
        income: totalInflow,
        expense: totalOutflow
    };

    return `
        <div class="space-y-6">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Dashboard</h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Inflow</p>
                        <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${formatCurrency(totalInflow)}</p>
                    </div>
                    <div class="p-2 bg-primary-100 dark:bg-primary-900/50 rounded-lg text-green-500">
                        ${ICONS.ArrowTrendingUp('w-6 h-6')}
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Outflow</p>
                        <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${formatCurrency(totalOutflow)}</p>
                    </div>
                    <div class="p-2 bg-primary-100 dark:bg-primary-900/50 rounded-lg text-red-500">
                        ${ICONS.ArrowTrendingDown('w-6 h-6')}
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Net Balance</p>
                        <p class="text-2xl font-bold ${netBalance >= 0 ? 'text-green-600' : 'text-red-600'} mt-1">${formatCurrency(netBalance)}</p>
                    </div>
                    <div class="p-2 bg-primary-100 dark:bg-primary-900/50 rounded-lg ${netBalance >= 0 ? 'text-green-500' : 'text-red-500'}">
                        ${ICONS.Wallet('w-6 h-6')}
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Accounts</p>
                        <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${state.accounts.length}</p>
                    </div>
                    <div class="p-2 bg-primary-100 dark:bg-primary-900/50 rounded-lg text-indigo-500">
                        ${ICONS.CreditCard('w-6 h-6')}
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-start justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Vouchers</p>
                        <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${state.vouchers.length}</p>
                    </div>
                    <div class="p-2 bg-primary-100 dark:bg-primary-900/50 rounded-lg text-purple-500">
                        ${ICONS.DocumentText('w-6 h-6')}
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                 <a href="#/vouchers/new" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer">
                    <div class="p-3 mb-2 bg-primary-100 dark:bg-primary-900/50 rounded-full">${ICONS.PlusCircle('w-6 h-6 text-primary-600')}</div>
                    <p class="font-semibold text-sm text-gray-700 dark:text-gray-200">Add Income</p>
                 </a>
                 <a href="#/vouchers/new" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer">
                    <div class="p-3 mb-2 bg-primary-100 dark:bg-primary-900/50 rounded-full">${ICONS.DocumentPlus('w-6 h-6 text-primary-600')}</div>
                    <p class="font-semibold text-sm text-gray-700 dark:text-gray-200">Add Expense</p>
                 </a>
                 <a href="#/accounts" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer">
                    <div class="p-3 mb-2 bg-primary-100 dark:bg-primary-900/50 rounded-full">${ICONS.UserPlus('w-6 h-6 text-primary-600')}</div>
                    <p class="font-semibold text-sm text-gray-700 dark:text-gray-200">New Account</p>
                 </a>
                 <a href="#/reports" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors cursor-pointer">
                    <div class="p-3 mb-2 bg-primary-100 dark:bg-primary-900/50 rounded-full">${ICONS.PresentationChartLine('w-6 h-6 text-primary-600')}</div>
                    <p class="font-semibold text-sm text-gray-700 dark:text-gray-200">View Reports</p>
                 </a>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Monthly Cash Flow</h3>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Income vs Expense</h3>
                    <div class="chart-container">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Expense Categories</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-4">Account Balances</h3>
                    <div class="chart-container">
                        <canvas id="accountChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">Recent Transactions</h3>
                <div class="overflow-x-auto">
                    ${recentTransactions.length > 0 ? `
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Voucher No.</th>
                                    <th scope="col" class="px-6 py-3">Narration</th>
                                    <th scope="col" class="px-6 py-3">Type</th>
                                    <th scope="col" class="px-6 py-3 text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentTransactions.map(voucher => {
                                    const totalDebit = voucher.voucher_entries.reduce((sum, e) => sum + parseFloat(e.debit), 0);
                                    const totalCredit = voucher.voucher_entries.reduce((sum, e) => sum + parseFloat(e.credit), 0);
                                    const amount = Math.abs(totalCredit - totalDebit);
                                    const statusClass = totalCredit > totalDebit ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
                                    const amountClass = totalCredit > totalDebit ? 'text-green-600' : 'text-red-600';
                                    const voucherNumber = voucher.voucher_number || `V-${voucher.id.slice(0, 8)}`;
                                    return `
                                    <tr class="bg-white dark:bg-gray-800 border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600/50">
                                        <td class="px-6 py-4">${new Date(voucher.date).toLocaleDateString()}</td>
                                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${voucherNumber}</td>
                                        <td class="px-6 py-4 truncate max-w-xs">${voucher.narration || voucher.voucher_entries.map(e => e.narration).filter(Boolean).join(', ')}</td>
                                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${voucher.type}</span></td>
                                        <td class="px-6 py-4 text-right font-semibold ${amountClass}">${formatCurrency(amount)}</td>
                                    </tr>`
                                }).join('')}
                            </tbody>
                        </table>
                    ` : `<div class="text-center py-8 text-gray-500 dark:text-gray-400">No transactions found.</div>`}
                </div>
            </div>
        </div>
        
    `;
};

// ... (Rest of the components remain the same but with improved UI)

// Rest of the code follows the same pattern with improved UI, error handling, and password protection

// Initialize the app
async function init() {
    try {
        const data = await loadData();
        state.accounts = data.accounts;
        state.vouchers = data.vouchers;
        state.settings = data.settings;
        state.ui = { isSidebarOpen: false };
        
        // Initialize voucher sequences
        initializeVoucherSequences();
        
        applyTheme(localStorage.getItem('theme'));
        window.addEventListener('hashchange', renderApp);
        renderApp();
        
        // Hide loading screen
        document.getElementById('loading').style.display = 'none';
    } catch (error) {
        console.error("Error initializing app:", error);
        document.getElementById('loading').innerHTML = `
            <div class="text-center">
                <div class="text-red-500 text-xl mb-4">Error Loading Application</div>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Failed to connect to database.</p>
                <button onclick="location.reload()" class="px-4 py-2 bg-primary-600 text-white rounded-md">Retry</button>
            </div>
        `;
    }
}

init();
</script>
</body>
</html>
